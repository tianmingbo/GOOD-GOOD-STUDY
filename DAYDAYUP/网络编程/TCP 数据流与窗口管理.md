## TCP 数据流与窗口管理

### 延时确认

> 1. 当接收方收到数据时，会延迟发送确认，等待一定时间内是否有更多数据到达。
> 2. 如果在延迟时间内没有收到更多数据，则会发送累积确认给发送方。
> 3. 如果在延迟时间内收到更多数据，则会将多个确认合并成一个累积确认一起发送。

### Nagle算法

> 1. 当发送端有一个小的报文段（小于SMSS），并且之前已经发送了一个小数据包但尚未收到ACK，Nagle 算法会将第二个小数据包缓存，等待第一个数据包被确认后再一起发送。
> 2. 当发送端发送一个大数据包时，Nagle 算法不会对数据包进行缓存，而是立即发送，以保证数据传输的及时性和效率。

#### 禁用

> 对延迟敏感的应用，应该禁用Nagle算法。socket **TCP_NODELAY**选项

### 滑动窗口

### 零窗口与TCP持续计时器

> 当接收方通告窗口变为0，发送方会停止发送。当接收方发送**窗口更新 window update**时，难免会存在丢失的问题，这会造成双方持续等待。
>
> 所以发送方收到**零窗口通知**，就会启动一个定时器，持续发送**窗口探测（zerowindowprobe）**报文。

### 糊涂窗口综合征

> 如果接收方太忙了，来不及取走接收窗口里的数据，那么就会导致发送方的发送窗口越来越小。到最后，**如果接收方腾出几个字节并告诉发送方现在有几个字节的窗口，而发送方会义无反顾地发送这几个字节，这就是糊涂窗口综合症**。

#### 解决

> 1. 对于接收方来说，使用 Nagle 算法，该算法的思路是延时处理，满足下面两个条件中的任意一个条件，才可以发送数据：
>    - 条件一：要等到窗口大小 >= `MSS` 并且 数据大小 >= `MSS`；
>    - 条件二：收到之前发送数据的 `ack` 回包；
> 2. 对于发送方来说：
>    - 当「窗口大小」小于 **min( MSS，接收端缓存空间/2 )** ，也就是小于 MSS 与 1/2 缓存大小中的最小值时，就会向发送方通告窗口为 `0`，也就阻止了发送方再发数据过来。